<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orders â€” Frankiemoji Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
  :root{
    --cream:#FAF3E0;
    --espresso:#2C2419;
    --graphite:#5A5350;
    --accent:#F5A623;
    --pill:#FFF8EC;
    --border:#E2D4BE;
  }

  *{
    box-sizing:border-box;
    margin:0;
    padding:0;
  }

  body{
    font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:var(--cream);
    color:var(--espresso);
    min-height:100vh;
  }

  /* ===== LAYOUT: SIDEBAR + MAIN ===== */

  .admin-layout{
    display:flex;
    min-height:100vh;
  }

  .admin-sidebar{
    position:sticky;
    top:0;
    align-self:flex-start;
    min-height:100vh;
    width:220px;
    padding:2rem 1.25rem 2rem;
    border-right:1px solid var(--border);
    background:#F6EBD7;
    display:flex;
    flex-direction:column;
  }

  .admin-logo{
    font-family:"DM Serif Display",serif;
    font-size:1.35rem;
    margin-bottom:1.5rem;
    color:var(--espresso);
  }

  .admin-nav{
    display:flex;
    flex-direction:column;
    gap:0.35rem;
    margin-bottom:2rem;
    font-size:0.85rem;
  }

  /* Sidebar buttons â€“ live-site style */
  .admin-nav a{
    display:flex;
    align-items:center;
    padding:0.45rem 0.9rem;
    border-radius:999px;
    font-size:0.85rem;
    font-weight:500;
    text-decoration:none;
    background:#FFF7EA;
    color:var(--espresso);
    border:1px solid var(--border);
    margin-bottom:0.35rem;
    transition:all 0.15s ease;
  }

  .admin-nav a:hover{
    background:#FFEFD9;
    border-color:var(--accent);
    transform:translateY(-1px);
    box-shadow:0 4px 10px rgba(44,36,25,0.10);
  }

  .admin-nav a.is-active{
    background:var(--espresso);
    color:#FFF7EA;
    border-color:var(--espresso);
    box-shadow:0 6px 14px rgba(44,36,25,0.22);
  }

  .admin-footnote{
    margin-top:auto;
    font-size:0.78rem;
    color:var(--graphite);
  }

  /* Mobile hamburger toggle */
  .nav-toggle{
    display:none;
    border:none;
    background:transparent;
    padding:0.25rem 0.5rem;
    border-radius:999px;
    cursor:pointer;
    font-size:1.2rem;
    margin-left:auto;
    margin-bottom:0.75rem;
  }

  .nav-toggle span{
    display:block;
    width:18px;
    height:2px;
    background:var(--espresso);
    border-radius:4px;
    position:relative;
  }

  .nav-toggle span::before,
  .nav-toggle span::after{
    content:"";
    position:absolute;
    left:0;
    width:18px;
    height:2px;
    background:var(--espresso);
    border-radius:4px;
  }

  .nav-toggle span::before{
    top:-5px;
  }
  .nav-toggle span::after{
    top:5px;
  }

  .admin-main{
    flex:1;
    display:flex;
    flex-direction:column;
    padding:0;
  }

  .admin-topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:0.75rem 1.75rem;
    border-bottom:1px solid var(--border);
    background:#F5EADB;
    font-size:0.8rem;
  }

  .topbar-left{
    display:flex;
    align-items:center;
    gap:0.5rem;
    font-weight:500;
  }

  .topbar-pill{
    display:inline-flex;
    align-items:center;
    padding:0.12rem 0.6rem;
    border-radius:999px;
    border:1px solid var(--border);
    background:#FFF7EA;
    font-size:0.75rem;
    gap:0.35rem;
  }

  .topbar-right{
    display:flex;
    align-items:center;
    gap:0.5rem;
    flex-wrap:wrap;
  }

  .topbar-link{
    text-decoration:none;
    font-size:0.78rem;
    padding:0.25rem 0.6rem;
    border-radius:999px;
    border:1px solid transparent;
    color:var(--espresso);
  }

  .topbar-link:hover{
    border-color:var(--border);
    background:#FFF7EA;
  }

  .shell{
    width:100%;
    max-width:1080px;
    margin:2rem auto 2.5rem;
    padding:0 1.5rem;
  }

  /* ===== HEADER ===== */

  header{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    margin-bottom:1.5rem;
    gap:1rem;
  }

  header h1{
    font-family:"DM Serif Display",serif;
    font-size:2.1rem;
    letter-spacing:0.03em;
  }

  header span.badge{
    background:var(--pill);
    border-radius:999px;
    padding:0.35rem 0.9rem;
    font-size:0.8rem;
    border:1px solid var(--border);
    text-transform:uppercase;
    letter-spacing:0.08em;
  }

  /* ===== CARDS / AUTH ===== */

  .card{
    background:#FFF7EA;
    border-radius:18px;
    border:1px solid var(--border);
    padding:1.25rem 1.5rem;
    box-shadow:0 10px 30px rgba(44,36,25,0.06);
    margin-bottom:1.25rem;
  }

  .card h2{
    font-size:1rem;
    text-transform:uppercase;
    letter-spacing:0.12em;
    font-weight:600;
    color:var(--graphite);
    margin-bottom:0.5rem;
  }

  .card-header-row{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    gap:1rem;
    margin-bottom:0.35rem;
  }

  .card-meta{
    font-size:0.75rem;
    color:var(--graphite);
    opacity:0.9;
  }

  .auth-row{
    display:flex;
    flex-wrap:wrap;
    gap:0.75rem;
    align-items:center;
  }

  .auth-row input{
    flex:1;
    min-width:220px;
    padding:0.55rem 0.75rem;
    border-radius:10px;
    border:1px solid var(--border);
    font-size:0.9rem;
    background:white;
  }

  button.primary{
    border:none;
    border-radius:999px;
    padding:0.55rem 1.2rem;
    font-size:0.9rem;
    font-weight:600;
    cursor:pointer;
    background:var(--espresso);
    color:#fff;
    display:inline-flex;
    align-items:center;
    gap:0.4rem;
    transition:transform 0.08s ease,
               box-shadow 0.08s ease,
               background 0.15s ease;
  }

  button.primary:hover{
    transform:translateY(-1px);
    box-shadow:0 6px 14px rgba(44,36,25,0.18);
    background:#221A11;
  }

  .status{
    margin-top:0.4rem;
    font-size:0.85rem;
  }
  .status.ok{color:#137D3B;}
  .status.err{color:#B02020;}

  /* ===== TABLE & ROWS ===== */

  .toolbar{
    display:flex;
    flex-wrap:wrap;
    justify-content:space-between;
    gap:0.75rem;
    margin-top:0.5rem;
    margin-bottom:0.5rem;
  }

  .search-block{
    display:flex;
    align-items:center;
    gap:0.5rem;
    flex:1;
  }

  .search-block input{
    flex:1;
    min-width:200px;
    padding:0.45rem 0.7rem;
    border-radius:999px;
    border:1px solid var(--border);
    font-size:0.8rem;
    background:#FFFDF7;
  }

  .auto-refresh{
    display:flex;
    align-items:center;
    gap:0.45rem;
    font-size:0.78rem;
    white-space:nowrap;
  }

  .auto-refresh label{
    display:inline-flex;
    align-items:center;
    gap:0.35rem;
    cursor:pointer;
  }

  .auto-refresh input[type="checkbox"]{
    width:32px;
    height:18px;
    border-radius:999px;
    appearance:none;
    -webkit-appearance:none;
    border:1px solid var(--border);
    background:#FFF;
    position:relative;
    outline:none;
    cursor:pointer;
  }

  .auto-refresh input[type="checkbox"]::before{
    content:"";
    position:absolute;
    top:1px;
    left:1px;
    width:14px;
    height:14px;
    border-radius:50%;
    background:var(--border);
    transition:transform 0.18s ease, background 0.18s ease;
  }

  .auto-refresh input[type="checkbox"]:checked{
    background:#C5EBD3;
    border-color:#059669;
  }

  .auto-refresh input[type="checkbox"]:checked::before{
    transform:translateX(12px);
    background:#059669;
  }

  .table-wrap{
    margin-top:0.5rem;
    border-radius:18px;
    border:1px solid var(--border);
    overflow:auto;
    background:#FFFDF7;
    width:100%;
    position:relative;
  }

  /* Scroll shadow overlays */
  .scroll-shadow{
    position:absolute;
    top:0;
    bottom:0;
    width:18px;
    pointer-events:none;
    opacity:0;
    transition:opacity 0.15s ease;
  }

  .scroll-shadow.left{
    left:0;
    background:linear-gradient(to right, rgba(250,243,224,0.96), rgba(250,243,224,0));
  }

  .scroll-shadow.right{
    right:0;
    background:linear-gradient(to left, rgba(250,243,224,0.96), rgba(250,243,224,0));
  }

  table{
    width:100%;
    border-collapse:collapse;
    font-size:0.85rem;
    min-width:1020px; /* keeps all columns readable on desktop */
  }

  thead{
    background:#F2E5CF;
    position:sticky;
    top:0;
    z-index:1;
    box-shadow:0 2px 4px rgba(44,36,25,0.10);
  }

  th,
  td{
    padding:0.55rem 0.7rem;
    border-bottom:1px solid #EDE0CC;
    text-align:left;
    vertical-align:top;
  }

  th{
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:0.08em;
    font-size:0.75rem;
    color:var(--graphite);
    white-space:nowrap;
  }

  tbody tr:nth-child(even){
    background:#FFF9EF;
  }

  .table-wrap tbody tr{
    cursor:pointer;
    transition:background 0.12s ease, transform 0.08s ease;
  }

  .table-wrap tbody tr:hover{
    background:#FFEFD9;
    transform:translateY(-1px);
  }

  tr.row-focused{
    box-shadow:0 0 0 2px rgba(245,166,35,0.6);
    position:relative;
  }

  /* Pack + expressions */

  .chip-pack{
    display:inline-flex;
    align-items:center;
    gap:0.25rem;
    padding:0.1rem 0.55rem;
    border-radius:999px;
    border:1px solid var(--border);
    background:#FFF;
    font-size:0.78rem;
    text-transform:capitalize;
  }

  .chip-pack span.dot{
    width:7px;
    height:7px;
    border-radius:999px;
    background:var(--accent);
  }

  .expr{
    max-width:280px;
    white-space:normal;
  }

  .expr span{
    display:inline-block;
    padding:0.08rem 0.4rem;
    margin:0.06rem 0.14rem 0.06rem 0;
    border-radius:999px;
    background:#FFF2D8;
    border:1px solid #F1D7A5;
    font-size:0.75rem;
  }

  .pill-meta{
    font-size:0.78rem;
    color:var(--graphite);
  }

  /* Amount column alignment */
  th.amount-col,
  td.amount-col{
    text-align:right;
    white-space:nowrap;
  }

  footer{
    margin-top:1.75rem;
    text-align:center;
    font-size:0.78rem;
    color:var(--graphite);
    opacity:0.8;
  }

  /* ===== STATUS SUMMARY + FILTERS ===== */

  .status-bar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:0.75rem;
    margin-bottom:0.25rem;
  }

  .status-summary{
    display:flex;
    flex-wrap:wrap;
    gap:0.35rem;
  }

  .status-pill{
    display:inline-flex;
    align-items:center;
    padding:0.12rem 0.6rem;
    border-radius:999px;
    font-size:0.78rem;
    font-weight:500;
    color:#fff;
    text-transform:capitalize;
  }

  .filter-row{
    display:flex;
    flex-wrap:wrap;
    gap:0.5rem;
    align-items:center;
    font-size:0.78rem;
  }

  .filter-btn{
    border-radius:999px;
    border:1px solid var(--border);
    background:#fff;
    padding:0.25rem 0.75rem;
    font-size:0.78rem;
    cursor:pointer;
  }

  .filter-btn.is-active{
    background:var(--espresso);
    color:#fff;
    border-color:var(--espresso);
  }

  #statusFilter{
    border-radius:999px;
    border:1px solid var(--border);
    background:#fff;
    padding:0.25rem 0.6rem;
    font-size:0.78rem;
  }

  /* Status colors */
  .status-new        { background:#6B7280; }  /* gray  */
  .status-queued     { background:#D97706; }  /* amber */
  .status-in_progress{ background:#2563EB; }  /* blue  */
  .status-done       { background:#059669; }  /* green */
  .status-error      { background:#B91C1C; }  /* red   */

  /* ===== RESPONSIVE ===== */

  /* Mobile / tablet sidebar + table behavior */
  @media (max-width:900px){

    .admin-layout{
      flex-direction:column;
    }

    .admin-sidebar{
      position:static;
      width:100%;
      min-height:auto;
      padding:0.75rem 1rem 0.75rem;
      flex-direction:row;
      align-items:center;
      justify-content:space-between;
      border-right:none;
      border-bottom:1px solid var(--border);
      background:#F6EBD7;
    }

    .admin-logo{
      font-size:1.2rem;
      margin-bottom:0;
    }

    .nav-toggle{
      display:inline-flex;
    }

    .admin-nav{
      flex-direction:column;
      gap:0.35rem;
      margin-bottom:0;
      display:none;
      width:100%;
      margin-top:0.75rem;
    }

    .admin-sidebar.is-open .admin-nav{
      display:flex;
    }

    .admin-footnote{
      display:none;
    }

    .admin-main{
      padding-top:0;
    }

    .admin-topbar{
      padding:0.6rem 1rem;
      flex-wrap:wrap;
      gap:0.5rem;
    }

    .shell{
      max-width:100%;
      margin:1.25rem auto 2rem;
      padding:0 1rem;
    }

    .table-wrap{
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }

    /* Make table scroll instead of crushing columns */
    table{
      min-width:900px;
    }
  }

  /* Extra-tight small screens (phone) */
  @media (max-width:720px){
    header{
      flex-direction:column;
      align-items:flex-start;
    }
    header h1{
      font-size:1.7rem;
    }
    .card{
      padding:1rem 1rem;
    }
    .toolbar{
      flex-direction:column;
      align-items:stretch;
    }
    .search-block{
      width:100%;
    }
  }
</style>
</head>
<body>
  <div class="admin-layout">
    <aside class="admin-sidebar" id="adminSidebar">
      <div class="admin-logo">Frankiemojiâ„¢</div>
      <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
        <span></span>
      </button>

      <nav class="admin-nav">
        <a href="/admin/orders.html" class="is-active">Orders</a>
        <a href="/upload.html">Upload test</a>
        <!-- future: <a href="/admin/reports.html">Reports</a> -->
      </nav>

      <div class="admin-footnote">Internal tools</div>
    </aside>

    <main class="admin-main">
      <div class="admin-topbar">
        <div class="topbar-left">
          <span>Frankiemojiâ„¢ Admin</span>
          <span class="topbar-pill">
            <span>Current admin</span>
            <strong id="adminName">Frank</strong>
          </span>
        </div>
        <div class="topbar-right">
          <span class="topbar-pill">v0.9.0 Â· Orders</span>
          <a class="topbar-link" href="/" target="_blank" rel="noreferrer">Main site</a>
          <a class="topbar-link" href="/index-main.html" target="_blank" rel="noreferrer">Expression Engine</a>
        </div>
      </div>

      <div class="shell">
        <header>
          <h1>Frankiemoji Orders</h1>
          <span class="badge">Internal Â· Admin View</span>
        </header>

        <!-- Auth card -->
        <section class="card">
          <h2>Access</h2>
          <p style="font-size:0.9rem;margin-bottom:0.6rem;">
            Enter your admin passphrase to view the latest emoji pack orders.
          </p>
          <div class="auth-row">
            <input type="password" id="adminKey" placeholder="Admin passphrase" autocomplete="current-password" />
            <button class="primary" id="loadBtn">
              <span>View orders</span> <span>ðŸ“¦</span>
            </button>
          </div>
          <div id="authStatus" class="status"></div>
          <!-- Notifications trigger -->
          <div class="auth-row" style="margin-top:1rem;">
           <button class="secondary" id="notifyBtn">
             <span>Send notifications</span>
             <span class="spinner"></span>
           </button>
          <span id="notifyStatus" style="font-size:0.85rem;margin-left:0.75rem;"></span>
        </div>
        </section>

        <!-- Orders table -->
        <section class="card" id="ordersCard" style="display:none;">
          <div class="card-header-row">
            <h2>Recent Orders</h2>
            <div class="card-meta" id="lastUpdatedMeta">Last updated: â€”</div>
          </div>

          <!-- Status summary + filters bar -->
          <div class="status-bar">
            <div class="status-summary" id="statusSummary"></div>

            <div class="filter-row">
              <span style="font-weight:600;">Range:</span>
              <button type="button" class="filter-btn is-active" data-range="all">All time</button>
              <button type="button" class="filter-btn" data-range="today">Today</button>
              <button type="button" class="filter-btn" data-range="7d">Last 7 days</button>

              <span style="font-weight:600;margin-left:0.5rem;">Status:</span>
              <select id="statusFilter">
                <option value="any">Any status</option>
                <option value="received">received</option>
                <option value="payment_pending">payment_pending</option>
                <option value="queued">queued</option>
                <option value="in_progress">in_progress</option>
                <option value="done">done</option>
                <option value="error">error</option>
              </select>
            </div>
          </div>

          <!-- Search + auto-refresh -->
          <div class="toolbar">
            <div class="search-block">
              <input
                type="search"
                id="searchInput"
                placeholder="Search by email, promo code, order ID, or expressionâ€¦"
              />
            </div>

            <div class="auto-refresh">
              <label>
                <input type="checkbox" id="autoRefreshToggle" />
                <span>Auto-refresh</span>
              </label>
              <span id="autoRefreshStatus">Off</span>
            </div>
          </div>

          <p class="pill-meta" id="summary"></p>

          <div class="table-wrap" id="tableWrap">
            <div class="scroll-shadow left" id="shadowLeft"></div>
            <div class="scroll-shadow right" id="shadowRight"></div>

            <table id="ordersTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Created</th>
                  <th>Pack</th>
                  <th>Status</th>
                  <th class="amount-col">Amount</th>
                  <th>Expressions</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Promo</th>
                  <th>Order&nbsp;ID</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <footer>
          Internal tooling for Frankiemojiâ„¢ Studios. Do not share this URL publicly.
        </footer>
      </div> <!-- /.shell -->
    </main>
  </div> <!-- /.admin-layout -->

  <script>
    const adminInput        = document.getElementById('adminKey');
    const loadBtn           = document.getElementById('loadBtn');
    const statusEl          = document.getElementById('authStatus');
    const ordersCard        = document.getElementById('ordersCard');
    const tbody             = document.querySelector('#ordersTable tbody');
    const summaryEl         = document.getElementById('summary');
    const statusSummaryEl   = document.getElementById('statusSummary');
    const rangeButtons      = Array.from(document.querySelectorAll('.filter-btn'));
    const statusSelect      = document.getElementById('statusFilter');
    const searchInput       = document.getElementById('searchInput');
    const autoRefreshToggle = document.getElementById('autoRefreshToggle');
    const autoRefreshStatus = document.getElementById('autoRefreshStatus');
    const lastUpdatedMeta   = document.getElementById('lastUpdatedMeta');
    const tableWrap         = document.getElementById('tableWrap');
    const shadowLeft        = document.getElementById('shadowLeft');
    const shadowRight       = document.getElementById('shadowRight');
    const navToggle         = document.getElementById('navToggle');
    const adminSidebar      = document.getElementById('adminSidebar');

    let allOrders     = [];
    let currentRange  = 'all';   // 'all' | 'today' | '7d'
    let currentStatus = 'any';   // 'any' or specific status
    let currentSearch = '';
    let autoRefreshInterval = null;
    const AUTO_REFRESH_MS = 30000;

    function setStatus(msg, type){
      statusEl.textContent = msg || '';
      statusEl.className = 'status' + (type ? ' ' + type : '');
    }

    function formatDateTime(iso){
      if (!iso) return '';
      const d = new Date(iso);
      return d.toLocaleString();
    }

    function updateScrollShadows(){
      if (!tableWrap) return;
      const scrollLeft = tableWrap.scrollLeft;
      const maxScroll  = tableWrap.scrollWidth - tableWrap.clientWidth;

      shadowLeft.style.opacity  = scrollLeft > 0 ? '1' : '0';
      shadowRight.style.opacity = scrollLeft < maxScroll - 1 ? '1' : '0';
    }

    function renderOrders(orders){
      tbody.innerHTML = '';

      if (!orders || !orders.length){
        summaryEl.textContent = 'No orders in this range yet.';
        if (statusSummaryEl) statusSummaryEl.textContent = '';
        return;
      }

      summaryEl.textContent = `${orders.length} orders in this view (newest first).`;

      const statusClassMap = {
        received:        'status-new',
        payment_pending: 'status-queued',
        queued:          'status-queued',
        in_progress:     'status-in_progress',
        done:            'status-done',
        error:           'status-error'
      };

      orders.forEach((o, idx) => {
        const tr = document.createElement('tr');

        const created = o.created_at ? formatDateTime(o.created_at) : '';

        const exprList = Array.isArray(o.expressions) ? o.expressions : [];
        const exprHtml = exprList.map(e => `<span>${e}</span>`).join('');

        const rawStatus   = (o.status || 'received').toLowerCase();
        const statusClass = statusClassMap[rawStatus] || 'status-new';
        const statusLabel = rawStatus.replace('_', ' ');

        const baseCents  = (typeof o.base_price_cents  === 'number') ? o.base_price_cents  : null;
        const finalCents = (typeof o.final_price_cents === 'number') ? o.final_price_cents : baseCents;
        let amountStr = '';
        if (typeof finalCents === 'number'){
          amountStr = '$' + (finalCents / 100).toFixed(2);
        }

        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${created}</td>
          <td>
            <span class="chip-pack">
              <span class="dot"></span>
              <span>${o.pack_type || 'starter'}</span>
            </span>
          </td>
          <td>
            <span class="status-pill ${statusClass}">
              ${statusLabel}
            </span>
          </td>
          <td class="amount-col">${amountStr}</td>
          <td class="expr">${exprHtml}</td>
          <td>${o.email || ''}</td>
          <td>${o.phone || ''}</td>
          <td>${o.promo_code || ''}</td>
          <td style="font-family:monospace;font-size:0.78rem;">${o.id}</td>
        `;

        tr.addEventListener('click', () => {
          window.location.href = '/admin/order/?id=' + encodeURIComponent(o.id);
        });

        tbody.appendChild(tr);
      });

      // Once rows exist, update scroll shadows
      updateScrollShadows();
    }

    function updateStatusSummary(orders){
      if (!statusSummaryEl) return;

      if (!orders || !orders.length){
        statusSummaryEl.textContent = '';
        return;
      }

      const counts = {
        received: 0,
        payment_pending: 0,
        queued: 0,
        in_progress: 0,
        done: 0,
        error: 0,
      };

      orders.forEach(o => {
        const s = (o.status || 'received').toLowerCase();
        if (Object.prototype.hasOwnProperty.call(counts, s)) counts[s] += 1;
      });

      statusSummaryEl.innerHTML = `
        <span class="status-pill status-new">Total: ${orders.length}</span>
        ${counts.received ? `<span class="status-pill status-new">received: ${counts.received}</span>` : ''}
        ${(counts.payment_pending || counts.queued) ? `<span class="status-pill status-queued">queued/pending: ${counts.payment_pending + counts.queued}</span>` : ''}
        ${counts.in_progress ? `<span class="status-pill status-in_progress">in progress: ${counts.in_progress}</span>` : ''}
        ${counts.done ? `<span class="status-pill status-done">done: ${counts.done}</span>` : ''}
        ${counts.error ? `<span class="status-pill status-error">error: ${counts.error}</span>` : ''}
      `;
    }

    function applyFilters(){
      let filtered = allOrders.slice();

      // Date range filter
      const now = new Date();
      filtered = filtered.filter(o => {
        if (!o.created_at) return true;
        const created = new Date(o.created_at);

        if (currentRange === 'today'){
          const todayStr   = now.toISOString().slice(0,10);
          const createdStr = created.toISOString().slice(0,10);
          if (createdStr !== todayStr) return false;
        } else if (currentRange === '7d'){
          const diffMs   = now - created;
          const diffDays = diffMs / (1000 * 60 * 60 * 24);
          if (diffDays > 7) return false;
        }
        return true;
      });

      // Status filter
      if (currentStatus && currentStatus !== 'any'){
        filtered = filtered.filter(o =>
          (o.status || '').toLowerCase() === currentStatus
        );
      }

      // Search filter
      const term = (currentSearch || '').trim().toLowerCase();
      if (term){
        filtered = filtered.filter(o => {
          const email  = (o.email || '').toLowerCase();
          const promo  = (o.promo_code || '').toLowerCase();
          const id     = (o.id || '').toLowerCase();
          const pack   = (o.pack_type || '').toLowerCase();
          const exprs  = Array.isArray(o.expressions) ? o.expressions.join(' ').toLowerCase() : '';

          return (
            email.includes(term) ||
            promo.includes(term) ||
            id.includes(term) ||
            pack.includes(term) ||
            exprs.includes(term)
          );
        });
      }

      renderOrders(filtered);
      updateStatusSummary(filtered);
    }

    async function loadOrders(isAuto=false){
      const key = adminInput.value.trim();
      if (!key){
        if (!isAuto){
          setStatus('Please enter your admin passphrase.', 'err');
        }
        return;
      }
      if (!isAuto){
        setStatus('Loading ordersâ€¦', '');
      }
      ordersCard.style.display = 'none';

      try{
        const res  = await fetch('/api/orders', {
          headers: { 'x-admin-key': key }
        });
        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data.ok){
          throw new Error(data.error || `Request failed (${res.status})`);
        }

        allOrders = data.orders || [];
        setStatus('Access granted. Orders loaded.', 'ok');
        ordersCard.style.display = 'block';
        applyFilters();

        const now = new Date();
        lastUpdatedMeta.textContent = 'Last updated: ' + now.toLocaleTimeString();
      } catch (err){
        console.error('loadOrders error', err);
        if (!isAuto){
          setStatus(err.message || 'Failed to load orders.', 'err');
          ordersCard.style.display = 'none';
        }
      }
    }

    function setAutoRefresh(enabled){
      if (enabled){
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        autoRefreshInterval = setInterval(() => {
          loadOrders(true);
        }, AUTO_REFRESH_MS);
        autoRefreshStatus.textContent = 'Every ' + (AUTO_REFRESH_MS/1000) + 's';
      } else{
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        autoRefreshStatus.textContent = 'Off';
      }
    }

    // Event wiring
    loadBtn.addEventListener('click', () => loadOrders(false));
    adminInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') loadOrders(false);
    });

    // Range buttons
    rangeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        rangeButtons.forEach(b => b.classList.remove('is-active'));
        btn.classList.add('is-active');
        currentRange = btn.dataset.range || 'all';
        applyFilters();
      });
    });

    // Status dropdown
    if (statusSelect){
      statusSelect.addEventListener('change', () => {
        currentStatus = statusSelect.value || 'any';
        applyFilters();
      });
    }

    // Search input
    if (searchInput){
      searchInput.addEventListener('input', () => {
        currentSearch = searchInput.value || '';
        applyFilters();
      });
    }

    // Auto-refresh toggle
    if (autoRefreshToggle){
      autoRefreshToggle.addEventListener('change', () => {
        setAutoRefresh(autoRefreshToggle.checked);
      });
    }

    // Table scroll shadows
    if (tableWrap){
      tableWrap.addEventListener('scroll', updateScrollShadows);
      window.addEventListener('resize', updateScrollShadows);
    }

    // Mobile nav toggle
    if (navToggle && adminSidebar){
      navToggle.addEventListener('click', () => {
        adminSidebar.classList.toggle('is-open');
      });
    }

    // Clean up interval if page is unloaded
    window.addEventListener('beforeunload', () => {
      if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    });
  </script>
</body>
</html>
