<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orders — Frankiemoji Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --cream:#FAF3E0;
      --espresso:#2C2419;
      --graphite:#5A5350;
      --accent:#F5A623;
      --pill:#FFF8EC;
      --border:#E2D4BE;
      --danger:#C0392B;
      --success:#1B8748;
      --pending:#F39C12;
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--cream);
      color:var(--espresso);
      min-height:100vh;
    }

    .admin-shell{
      max-width:1260px;           /* a little wider for breathing room */
      margin:32px auto 40px;
      padding:24px 24px 40px;
      background:#fff;
      border-radius:24px;
      box-shadow:0 18px 45px rgba(0,0,0,0.06);
      border:1px solid rgba(44,36,25,0.06);
    }

    .admin-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:24px;
    }

    .admin-title-block h1{
      font-family:"DM Serif Display",serif;
      font-size:28px;
      letter-spacing:.02em;
      margin-bottom:4px;
    }

    .admin-title-block p{
      font-size:14px;
      color:var(--graphite);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      padding:4px 10px;
      border-radius:999px;
      background:var(--pill);
      border:1px solid var(--border);
      color:var(--graphite);
    }

    .badge span.dot{
      width:6px;
      height:6px;
      border-radius:999px;
      background:#27AE60;
    }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-size:12px;
      align-items:center;
      justify-content:flex-end;
    }

    .key-hint{
      padding:4px 10px;
      border-radius:999px;
      border:1px dashed var(--border);
      background:var(--pill);
      color:var(--graphite);
      display:flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.14em;
    }

    .key-hint.ok{
      border-style:solid;
      border-color:var(--success);
      background:#EAF7F0;
      color:var(--success);
    }

    .toolbar button{
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      padding:6px 10px;
      font-size:12px;
      cursor:pointer;
    }

    .toolbar button:hover{
      background:var(--pill);
    }

    .toolbar button[disabled]{
      opacity:.5;
      cursor:default;
    }

    .table-wrap{
      margin-top:8px;
      border-radius:18px;
      border:1px solid var(--border);
      overflow:hidden;
      background:var(--pill);
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }

    thead{
      background:#F4E7CF;
    }

    th,td{
      padding:9px 10px;
      text-align:left;
      border-bottom:1px solid rgba(0,0,0,0.03);
      vertical-align:middle;
    }

    th{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--graphite);
      white-space:nowrap;
    }

    tbody tr:nth-child(even){
      background:#FFFDF8;
    }

    tbody tr:hover{
      background:#FFF7E8;
    }

    .mono{
      font-family:Menlo,Consolas,monospace;
      font-size:11px;
    }

    .pill-status{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .pill-status.new{
      background:#FDF2D8;
      color:var(--pending);
    }

    .pill-status.ready{
      background:#E4F7EB;
      color:var(--success);
    }

    .pill-status.error{
      background:#FDEAEA;
      color:var(--danger);
    }

    .pill-status.paid{
      background:#E8F3FF;
      color:#1A73E8;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:22px;
      height:22px;
      border-radius:999px;
      font-size:13px;
      border:1px solid var(--border);
      background:#fff;
    }

    .tag.ok{
      border-color:var(--success);
      color:var(--success);
      background:#EAF7F0;
    }

    .tag.off{
      color:var(--graphite);
      background:#F7EFE0;
    }

    .btn-ghost{
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      padding:4px 10px;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }

    .btn-ghost.small{
      font-size:11px;
      padding:3px 8px;
    }

    .btn-ghost.primary{
      border-color:var(--accent);
      color:var(--espresso);
      background:#FFE9C4;
    }

    .btn-ghost[disabled]{
      opacity:.55;
      cursor:default;
    }

    .empty{
      padding:18px;
      font-size:13px;
      color:var(--graphite);
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      padding:10px 14px;
      border-radius:999px;
      font-size:13px;
      background:#2C2419;
      color:#fff;
      display:none;
      box-shadow:0 12px 30px rgba(0,0,0,0.25);
      z-index:999;
    }

    .toast.ok{
      background:#1B8748;
    }
    .toast.error{
      background:#C0392B;
    }

    @media (max-width:760px){
      .admin-shell{
        margin:16px;
        padding:18px 14px 28px;
      }
      .admin-header{
        flex-direction:column;
        align-items:flex-start;
      }
      .toolbar{
        justify-content:flex-start;
      }
      table{
        font-size:12px;
      }
      th:nth-child(3), td:nth-child(3),
      th:nth-child(4), td:nth-child(4){
        display:none; /* hide some columns on tiny screens */
      }
    }
  </style>
</head>
<body>
  <div class="admin-shell">
    <header class="admin-header">
      <div class="admin-title-block">
        <div class="badge">
          <span class="dot"></span>
          <span>Frankiemoji Admin</span>
        </div>
        <h1>Orders</h1>
        <p>Review emoji orders, send notifications, and track SMS / email status.</p>
      </div>
      <div class="toolbar">
        <div id="auth-status" class="key-hint">
          <span id="auth-label">Locked</span>
        </div>
        <button id="unlock-btn" type="button">Unlock admin</button>
        <button id="refresh-btn" type="button" disabled>↻ Refresh</button>
      </div>
    </header>

    <section class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Customer</th>
            <th>Pack</th>
            <th>Expressions</th>
            <th>Status</th>
            <th>SMS</th>
            <th>Email</th>
            <th>Notify</th>
          </tr>
        </thead>
        <tbody id="orders-body">
          <tr><td colspan="8" class="empty">Admin key required. Click “Unlock admin” above.</td></tr>
        </tbody>
      </table>
    </section>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // Admin key is NOT hard-coded; you type it at runtime.
    let adminKey = null;

    const tbody      = document.getElementById('orders-body');
    const toastEl    = document.getElementById('toast');
    const refreshBtn = document.getElementById('refresh-btn');
    const unlockBtn  = document.getElementById('unlock-btn');
    const authStatus = document.getElementById('auth-status');
    const authLabel  = document.getElementById('auth-label');

    function setLockedUI(locked){
      if (locked){
        adminKey = null;
        authLabel.textContent = 'Locked';
        authStatus.classList.remove('ok');
        refreshBtn.disabled = true;
        tbody.innerHTML =
          '<tr><td colspan="8" class="empty">Admin key required. Click “Unlock admin” above.</td></tr>';
      } else {
        authLabel.textContent = 'Unlocked';
        authStatus.classList.add('ok');
        refreshBtn.disabled = false;
      }
    }

    function showToast(message, type='ok', duration=2600){
      toastEl.textContent = message;
      toastEl.className = 'toast ' + type;
      toastEl.style.display = 'block';
      window.clearTimeout(showToast._timer);
      showToast._timer = window.setTimeout(() => {
        toastEl.style.display = 'none';
      }, duration);
    }

    function formatDate(iso){
      if(!iso) return '—';
      try{
        const d = new Date(iso);
        return d.toLocaleString(undefined,{
          month:'short',day:'2-digit',
          hour:'2-digit',minute:'2-digit'
        });
      }catch(e){
        return iso;
      }
    }

    function renderStatus(order){
      const s = (order.status || '').toLowerCase();
      if(s === 'pack_ready' || s === 'ready'){
        return '<span class="pill-status ready">Ready</span>';
      }
      if(s === 'payment_received' || s === 'paid'){
        return '<span class="pill-status paid">Paid</span>';
      }
      if(s === 'error'){
        return '<span class="pill-status error">Error</span>';
      }
      return '<span class="pill-status new">New</span>';
    }

    function renderTag(flag){
      if(flag) return '<span class="tag ok">✓</span>';
      return '<span class="tag off">–</span>';
    }

    function buildRow(order){
      const expCount = Array.isArray(order.expressions)
        ? order.expressions.length
        : (order.expressions_count || 0);
      const sms   = !!(order.sms_sent   || order.smsSent);
      const email = !!(order.email_sent || order.emailSent);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatDate(order.created_at)}</td>
        <td>
          <div>${order.email || '—'}</div>
          <div class="mono">${order.id}</div>
        </td>
        <td>${order.pack_type || '—'}</td>
        <td>${expCount || '—'}</td>
        <td>${renderStatus(order)}</td>
        <td class="sms-cell">${renderTag(sms)}</td>
        <td class="email-cell">${renderTag(email)}</td>
        <td>
          <div style="display:flex;gap:4px;flex-wrap:wrap">
            <button class="btn-ghost small"
              data-action="order_received"
              data-id="${order.id}">
              Order received
            </button>
            <button class="btn-ghost small primary"
              data-action="pack_ready"
              data-id="${order.id}">
              Pack ready
            </button>
          </div>
        </td>
      `;
      return tr;
    }

    async function loadOrders(){
      if (!adminKey){
        setLockedUI(true);
        showToast('Enter admin key first','error');
        return;
      }

      tbody.innerHTML = '<tr><td colspan="8" class="empty">Loading orders…</td></tr>';

      try{
        const res = await fetch('/api/orders', {
          method:'GET',
          headers:{
            'Content-Type':'application/json',
            'x-admin-key': adminKey
          }
        });

        if(res.status === 401 || res.status === 403){
          setLockedUI(true);
          const text = await res.text();
          console.error('[orders] Unauthorized', res.status, text);
          showToast('Admin key rejected','error');
          return;
        }

        if(!res.ok){
          const text = await res.text();
          console.error('[orders] Load failed', res.status, text);
          tbody.innerHTML =
            '<tr><td colspan="8" class="empty">Error loading orders ('+res.status+'). Check console.</td></tr>';
          showToast('Failed to load orders ('+res.status+')','error');
          return;
        }

        const json = await res.json();
        const orders = json.orders || json.data || [];

        if(!orders.length){
          tbody.innerHTML =
            '<tr><td colspan="8" class="empty">No orders yet.</td></tr>';
          return;
        }

        tbody.innerHTML = '';
        orders.forEach(order => {
          const row = buildRow(order);
          tbody.appendChild(row);
        });
      }catch(err){
        console.error('[orders] Unexpected error', err);
        tbody.innerHTML =
          '<tr><td colspan="8" class="empty">Unexpected error loading orders. See console.</td></tr>';
        showToast('Unexpected error loading orders','error');
      }
    }

    async function sendNotify(orderId, type, buttonEl){
      if (!adminKey){
        showToast('Enter admin key first','error');
        return;
      }
      if(!orderId || !type) return;

      const originalLabel = buttonEl.textContent;
      buttonEl.disabled = true;
      buttonEl.textContent = 'Sending…';

      try{
        const res = await fetch('/api/notify', {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({ orderId, type })
        });

        if(res.status === 401 || res.status === 403){
          setLockedUI(true);
          const text = await res.text();
          console.error('[notify] Unauthorized', res.status, text);
          showToast('Admin key rejected','error');
          return;
        }

        const text = await res.text();
        let json = {};
        try{ json = text ? JSON.parse(text) : {}; }catch(e){}

        if(!res.ok || json.ok === false){
          console.error('[notify] Error', res.status, text);
          showToast('Notify failed ('+res.status+')','error');
        }else{
          const row = buttonEl.closest('tr');
          if(row && json){
            const smsCell   = row.querySelector('.sms-cell');
            const emailCell = row.querySelector('.email-cell');
            if(typeof json.smsSent === 'boolean' && smsCell){
              smsCell.innerHTML = renderTag(json.smsSent);
            }
            if(typeof json.emailSent === 'boolean' && emailCell){
              emailCell.innerHTML = renderTag(json.emailSent);
            }
          }
          showToast('Notification sent ✅','ok');
        }
      }catch(err){
        console.error('[notify] Unexpected error', err);
        showToast('Notify error – see console','error');
      }finally{
        buttonEl.disabled = false;
        buttonEl.textContent = originalLabel;
      }
    }

    // Event delegation for notify buttons
    tbody.addEventListener('click', (evt) => {
      const btn = evt.target.closest('button[data-action]');
      if(!btn) return;
      const type = btn.getAttribute('data-action') === 'pack_ready'
        ? 'pack_ready'
        : 'order_received';
      const id = btn.getAttribute('data-id');
      if(!id) return;
      sendNotify(id, type, btn);
    });

    refreshBtn.addEventListener('click', () => {
      loadOrders();
    });

    unlockBtn.addEventListener('click', () => {
      const key = window.prompt('Enter admin key (x-admin-key)');
      if(!key) return;
      adminKey = key.trim();
      setLockedUI(false);
      showToast('Admin key set','ok');
      loadOrders();
    });

    // Start in locked state
    setLockedUI(true);
  </script>
</body>
</html>
