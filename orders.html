<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orders â€” Frankiemoji Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --cream:#FAF3E0;
      --espresso:#2C2419;
      --graphite:#5A5350;
      --accent:#F5A623;
      --pill:#FFF8EC;
      --border:#E2D4BE;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--cream);
      color:var(--espresso);
      min-height:100vh;
    }
        .admin-layout{
      display:flex;
      min-height:100vh;
    }
    .admin-nav{
      width:220px;
      padding:2.5rem 1.25rem 2rem;
      border-right:1px solid var(--border);
      background:#F6EBD7;
      position:sticky;
      top:0;
      align-self:flex-start;
    }
    .admin-nav h2{
      font-family:"DM Serif Display",serif;
      font-size:1.1rem;
      margin-bottom:1rem;
    }
    .admin-nav ul{
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-direction:column;
      gap:0.4rem;
      font-size:0.85rem;
    }
    .admin-nav a{
      text-decoration:none;
      color:var(--graphite);
      padding:0.35rem 0.6rem;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      gap:0.35rem;
    }
    .admin-nav a span.icon{
      font-size:0.9rem;
    }
    .admin-nav a.is-active{
      background:#2C2419;
      color:#FFF7EA;
    }
    @media (max-width:960px){
      .admin-layout{
        flex-direction:column;
      }
      .admin-nav{
        width:100%;
        display:flex;
        align-items:center;
        justify-content:space-between;
        border-right:none;
        border-bottom:1px solid var(--border);
      }
    }
    .shell{
      max-width:1300px;
      margin:2.5rem auto 3rem;
      padding:0 1.25rem;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      margin-bottom:1.5rem;
      gap:1rem;
    }
    header h1{
      font-family:"DM Serif Display",serif;
      font-size:2.1rem;
      letter-spacing:0.03em;
    }
    header span.badge{
      background:var(--pill);
      border-radius:999px;
      padding:0.35rem 0.9rem;
      font-size:0.8rem;
      border:1px solid var(--border);
      text-transform:uppercase;
      letter-spacing:0.08em;
    }

    .card{
      background:#FFF7EA;
      border-radius:18px;
      border:1px solid var(--border);
      padding:1.25rem 1.5rem;
      box-shadow:0 10px 30px rgba(44,36,25,0.06);
      margin-bottom:1.25rem;
    }
    .card h2{
      font-size:1rem;
      text-transform:uppercase;
      letter-spacing:0.12em;
      font-weight:600;
      color:var(--graphite);
      margin-bottom:0.5rem;
    }
    .auth-row{
      display:flex;
      flex-wrap:wrap;
      gap:0.75rem;
      align-items:center;
    }
    .auth-row input{
      flex:1;
      min-width:220px;
      padding:0.55rem 0.75rem;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:0.9rem;
      background:white;
    }
    button.primary{
      border:none;
      border-radius:999px;
      padding:0.55rem 1.2rem;
      font-size:0.9rem;
      font-weight:600;
      cursor:pointer;
      background:var(--espresso);
      color:#fff;
      display:inline-flex;
      align-items:center;
      gap:0.4rem;
      transition:transform 0.08s ease,box-shadow 0.08s ease,background 0.15s ease;
    }
    button.primary:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 14px rgba(44,36,25,0.18);
      background:#221A11;
    }
    .status{
      margin-top:0.4rem;
      font-size:0.85rem;
    }
    .status.ok{color:#137D3B;}
    .status.err{color:#B02020;}

    .table-wrap{
      margin-top:0.5rem;
      border-radius:18px;
      border:1px solid var(--border);
      overflow:auto;
      background:#FFFDF7;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:0.85rem;
      min-width:900px;
    }
      thead{
      background:#F2E5CF;
      position:sticky;
      top:0;
      z-index:1;
      box-shadow:0 2px 4px rgba(0,0,0,0.04);
    }

    th,td{
      padding:0.55rem 0.7rem;
      border-bottom:1px solid #EDE0CC;
      text-align:left;
      vertical-align:top;
    }
    th{
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-size:0.75rem;
      color:var(--graphite);
      white-space:nowrap;
    }
     tbody tr:hover{
      background:#FFF3E0;
    }
     tr.row-focused{
      box-shadow:0 0 0 2px rgba(245,166,35,0.6);
      position:relative;
    }

    .chip-pack{
      display:inline-flex;
      align-items:center;
      gap:0.25rem;
      padding:0.1rem 0.55rem;
      border-radius:999px;
      border:1px solid var(--border);
      background:#FFF;
      font-size:0.78rem;
      text-transform:capitalize;
    }
    .chip-pack span.dot{
      width:7px;
      height:7px;
      border-radius:999px;
      background:var(--accent);
    }
    .expr{
      max-width:280px;
      white-space:normal;
    }
    .expr span{
      display:inline-block;
      padding:0.08rem 0.4rem;
      margin:0.06rem 0.14rem 0.06rem 0;
      border-radius:999px;
      background:#FFF2D8;
      border:1px solid #F1D7A5;
      font-size:0.75rem;
    }
    .pill-meta{
      font-size:0.78rem;
      color:var(--graphite);
    }
    footer{
      margin-top:1.75rem;
      text-align:center;
      font-size:0.78rem;
      color:var(--graphite);
      opacity:0.8;
    }
    @media (max-width:720px){
      header{
        flex-direction:column;
        align-items:flex-start;
      }
      header h1{font-size:1.7rem;}
      .card{padding:1rem 1rem;}
    }

    /* --- Status pills + summary bar --- */
    .status-bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:0.75rem;
      margin-bottom:0.75rem;
    }
    .status-summary{
      display:flex;
      flex-wrap:wrap;
      gap:0.35rem;
    }
    .status-pill{
      display:inline-flex;
      align-items:center;
      padding:0.12rem 0.6rem;
      border-radius:999px;
      font-size:0.78rem;
      font-weight:500;
      color:#fff;
      text-transform:capitalize;
    }

    /* Date-range + status filter controls */
    .filter-row{
      display:flex;
      flex-wrap:wrap;
      gap:0.5rem;
      align-items:center;
      font-size:0.78rem;
    }
    .filter-btn{
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      padding:0.25rem 0.75rem;
      font-size:0.78rem;
      cursor:pointer;
    }
    .filter-btn.is-active{
      background:var(--espresso);
      color:#fff;
      border-color:var(--espresso);
    }
    #statusFilter{
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      padding:0.25rem 0.6rem;
      font-size:0.78rem;
    }

    /* status color classes */
    .status-new        { background:#6B7280; }  /* gray  */
    .status-queued     { background:#D97706; }  /* amber */
    .status-in_progress{ background:#2563EB; }  /* blue  */
    .status-done       { background:#059669; }  /* green */
    .status-error      { background:#B91C1C; }  /* red   */
    /* --- Sidebar tweak: keep admin nav fixed-ish on scroll --- */
    .admin-sidebar{
     position: sticky;
     top: 0;
     align-self: flex-start;
     min-height: 100vh;
     }

/* --- Amount column alignment --- */
th.amount-col,
td.amount-col{
  text-align: right;
  white-space: nowrap;
}

/* --- Sticky header shadow + row hover / click state --- */
.table-wrap thead{
  box-shadow: 0 2px 4px rgba(44,36,25,0.10);
}

.table-wrap tbody tr{
  cursor: pointer;
  transition: background 0.12s ease, transform 0.08s ease;
}

.table-wrap tbody tr:hover{
  background: #FFEFD9;
  transform: translateY(-1px);
}

  </style>
</head>
<body>
  <div class="admin-layout">
    <aside class="admin-sidebar">
      <div class="admin-logo">Frankiemojiâ„¢</div>

      <nav class="admin-nav">
        <a href="/orders.html" class="is-active">Orders</a>
        <a href="/upload.html">Upload test</a>
        <!-- future: <a href="/reports.html">Reports</a> -->
      </nav>

      <div class="admin-footnote">Internal tools</div>
    </aside>

    <main class="admin-main">
      <div class="shell">
        <header>
          <h1>Frankiemoji Orders</h1>
          <span class="badge">Internal Â· Admin View</span>
        </header>

    <!-- Auth card -->
    <section class="card">
      <h2>Access</h2>
      <p style="font-size:0.9rem;margin-bottom:0.6rem;">
        Enter your admin passphrase to view the latest emoji pack orders.
      </p>
      <div class="auth-row">
        <input type="password" id="adminKey" placeholder="Admin passphrase" autocomplete="current-password" />
        <button class="primary" id="loadBtn">
          <span>View orders</span> <span>ðŸ“¦</span>
        </button>
      </div>
      <div id="authStatus" class="status"></div>
    </section>

    <!-- Orders table -->
    <section class="card" id="ordersCard" style="display:none;">
      <h2>Recent Orders</h2>

      <!-- Status summary + filters bar -->
      <div class="status-bar">
        <div class="status-summary" id="statusSummary"></div>

        <div class="filter-row">
          <span style="font-weight:600;">Range:</span>
          <button type="button" class="filter-btn is-active" data-range="all">All time</button>
          <button type="button" class="filter-btn" data-range="today">Today</button>
          <button type="button" class="filter-btn" data-range="7d">Last 7 days</button>

          <span style="font-weight:600;margin-left:0.5rem;">Status:</span>
          <select id="statusFilter">
            <option value="any">Any status</option>
            <option value="received">received</option>
            <option value="payment_pending">payment_pending</option>
            <option value="queued">queued</option>
            <option value="in_progress">in_progress</option>
            <option value="done">done</option>
            <option value="error">error</option>
          </select>
        </div>
      </div>

      <p class="pill-meta" id="summary"></p>

      <div class="table-wrap">
        <table id="ordersTable">
          <thead>
            <tr>
            <th>#</th>
            <th>Created</th>
            <th>Pack</th>
            <th>Status</th>
            <th class="amount-col">Amount</th>
            <th>Expressions</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Promo</th>
            <th>Order&nbsp;ID</th>
          </tr>
        </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <footer>
      Internal tooling for Frankiemojiâ„¢ Studios. Do not share this URL publicly.
    </footer>
        </div> <!-- /.shell -->
      </main>
    </div> <!-- /.admin-layout -->

  <script>
    const adminInput   = document.getElementById('adminKey');
    const loadBtn      = document.getElementById('loadBtn');
    const statusEl     = document.getElementById('authStatus');
    const ordersCard   = document.getElementById('ordersCard');
    const tbody        = document.querySelector('#ordersTable tbody');
    const summaryEl    = document.getElementById('summary');
    const statusSummaryEl = document.getElementById('statusSummary');
    const rangeButtons = Array.from(document.querySelectorAll('.filter-btn'));
    const statusSelect = document.getElementById('statusFilter');

    let allOrders     = [];
    let currentRange  = 'all';   // 'all' | 'today' | '7d'
    let currentStatus = 'any';   // 'any' or specific status

    function setStatus(msg, type){
      statusEl.textContent = msg || '';
      statusEl.className = 'status' + (type ? ' ' + type : '');
    }

    function renderOrders(orders){
      tbody.innerHTML = '';

      if (!orders || !orders.length){
       summaryEl.textContent = 'No orders in this range yet.';
       if (statusSummaryEl) statusSummaryEl.textContent = '';
       return;
    }

     summaryEl.textContent = `${orders.length} orders in this view (newest first).`;

    const statusClassMap = {
     received:        'status-new',
     payment_pending: 'status-queued',
     queued:          'status-queued',
     in_progress:     'status-in_progress',
     done:            'status-done',
     error:           'status-error'
   };

   orders.forEach((o, idx) => {
    const tr = document.createElement('tr');

    // Created timestamp
     const created = o.created_at
      ? new Date(o.created_at).toLocaleString()
      : '';

    // Expressions
    const exprList = Array.isArray(o.expressions) ? o.expressions : [];
    const exprHtml = exprList.map(e => `<span>${e}</span>`).join('');

    // Status pill
    const rawStatus   = (o.status || 'received').toLowerCase();
    const statusClass = statusClassMap[rawStatus] || 'status-new';
    const statusLabel = rawStatus.replace('_', ' ');

    // Amount logic: prefer final_price_cents, fall back to base_price_cents
    const baseCents  = (typeof o.base_price_cents  === 'number') ? o.base_price_cents  : null;
    const finalCents = (typeof o.final_price_cents === 'number') ? o.final_price_cents : baseCents;
    let amountStr = '';
    if (typeof finalCents === 'number'){
      amountStr = '$' + (finalCents / 100).toFixed(2);
    }

    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${created}</td>
      <td>
        <span class="chip-pack">
          <span class="dot"></span>
          <span>${o.pack_type || 'starter'}</span>
        </span>
      </td>
      <td>
        <span class="status-pill ${statusClass}">
          ${statusLabel}
        </span>
      </td>
      <td class="amount-col">${amountStr}</td>
      <td class="expr">${exprHtml}</td>
      <td>${o.email || ''}</td>
      <td>${o.phone || ''}</td>
      <td>${o.promo_code || ''}</td>
      <td style="font-family:monospace;font-size:0.78rem;">${o.id}</td>
    `;

    // Row deep-link to detailed admin view
    tr.addEventListener('click', () => {
      // opens /admin/order/?id=xxxxx in the SAME tab
      window.location.href = '/admin/order/?id=' + encodeURIComponent(o.id);
    });

    tbody.appendChild(tr);
  });
}

    function updateStatusSummary(orders){
      if (!statusSummaryEl) return;

      if (!orders || !orders.length){
        statusSummaryEl.textContent = '';
        return;
      }

      const counts = {
        received: 0,
        payment_pending: 0,
        queued: 0,
        in_progress: 0,
        done: 0,
        error: 0,
      };

      orders.forEach(o => {
        const s = (o.status || 'received').toLowerCase();
        if (counts.hasOwnProperty(s)) counts[s] += 1;
      });

      statusSummaryEl.innerHTML = `
        <span class="status-pill status-new">Total: ${orders.length}</span>
        ${counts.received ? `<span class="status-pill status-new">received: ${counts.received}</span>` : ''}
        ${(counts.payment_pending || counts.queued) ? `<span class="status-pill status-queued">queued/pending: ${counts.payment_pending + counts.queued}</span>` : ''}
        ${counts.in_progress ? `<span class="status-pill status-in_progress">in progress: ${counts.in_progress}</span>` : ''}
        ${counts.done ? `<span class="status-pill status-done">done: ${counts.done}</span>` : ''}
        ${counts.error ? `<span class="status-pill status-error">error: ${counts.error}</span>` : ''}
      `;
    }

    function applyFilters(){
      let filtered = allOrders.slice();

      // Date range filter
      const now = new Date();
      filtered = filtered.filter(o => {
        if (!o.created_at) return true;
        const created = new Date(o.created_at);

        if (currentRange === 'today'){
          const todayStr   = now.toISOString().slice(0,10);
          const createdStr = created.toISOString().slice(0,10);
          if (createdStr !== todayStr) return false;
        } else if (currentRange === '7d'){
          const diffMs   = now - created;
          const diffDays = diffMs / (1000 * 60 * 60 * 24);
          if (diffDays > 7) return false;
        }
        return true;
      });

      // Status filter
      if (currentStatus && currentStatus !== 'any'){
        filtered = filtered.filter(o =>
          (o.status || '').toLowerCase() === currentStatus
        );
      }

      renderOrders(filtered);
      updateStatusSummary(filtered);
    }

    async function loadOrders(){
      const key = adminInput.value.trim();
      if (!key){
        setStatus('Please enter your admin passphrase.', 'err');
        return;
      }
      setStatus('Loading ordersâ€¦', '');
      ordersCard.style.display = 'none';

      try{
        const res  = await fetch('/api/orders', {
          headers: { 'x-admin-key': key }
        });
        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data.ok){
          throw new Error(data.error || `Request failed (${res.status})`);
        }

        allOrders = data.orders || [];
        setStatus('Access granted. Orders loaded.', 'ok');
        ordersCard.style.display = 'block';
        applyFilters();
      } catch (err){
        console.error('loadOrders error', err);
        setStatus(err.message || 'Failed to load orders.', 'err');
        ordersCard.style.display = 'none';
      }
    }

    loadBtn.addEventListener('click', loadOrders);
    adminInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') loadOrders();
    });

    // Range buttons
    rangeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        rangeButtons.forEach(b => b.classList.remove('is-active'));
        btn.classList.add('is-active');
        currentRange = btn.dataset.range || 'all';
        applyFilters();
      });
    });

    // Status dropdown
    if (statusSelect){
      statusSelect.addEventListener('change', () => {
        currentStatus = statusSelect.value || 'any';
        applyFilters();
      });
    }
  </script>
</body>
</html>
