<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Start your pack — Frankiemoji</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- build: v8.5.0 -->
  <style>
    :root{
      --cream:#FAF3E0;
      --espresso:#2C2419;
      --graphite:#5F5B53;
      --amber:#F0C06C;
      --accent:#D8742B;
      --paper:#F8E8CC;
    }

    /* Hide redundant selected-expression row under the picker */
    .selected-expressions,
    .selected-tags,
    #selected-expressions,
    div[id^="selected-"],
    div[class*="selected-expression"],
    div[class*="selected-expressions"] {
      display: none !important;
    }
    
    /* hide duplicate row of selected expressions */
    #expr-thumbs {
      display: none !important;
    }

    * { box-sizing:border-box; }
    html, body {
      margin:0;
      padding:0;
      background:var(--cream);
      color:var(--espresso);
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
    }
    img { display:block; max-width:100%; }
    .container { max-width:1100px; margin:0 auto; padding:0 24px; }

    /* Top bar */
    .topbar{position:sticky;top:0;z-index:50;background:rgba(250,243,224,.97);backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid #e8dfcc}
    .topbar-inner{display:flex;justify-content:center;gap:16px;padding:10px 0}
    .nav-btn{background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:12px;font-weight:600;cursor:pointer;transition:all .2s}
    .nav-btn:hover{background:#b85f22;transform:translateY(-1px)}

    /* Hero + marquee */
    .hero{text-align:center;padding:32px 0 8px}
    .hero h1{margin:0 0 6px;font-size:42px}
    .hero-sub{color:var(--graphite);max-width:520px;margin:0 auto}

    /* Pack badge under hero */
    .hero-pack {
      margin-top: 16px;
      text-align: center;
    }

    /* Base pill style – matches button color */
    .pack-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 22px;
      border-radius: 999px;
      background: var(--accent);
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.2px;
      box-shadow: 0 2px 6px rgba(0,0,0,.12);
      transition: transform .15s ease, box-shadow .15s ease;
    }

    /* Slightly larger for the hero badge */
    .pack-pill-large {
      padding: 12px 28px;
      font-size: 17px;
      font-weight: 700;
    }

    .pack-pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0,0,0,.16);
    }

    /* Expressions area */
    #expr-row {
      flex-direction: column;
      align-items: center;
      margin: 12px 0 18px;
    }

    #expr-label {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      margin-bottom: 10px;
    }

    #expr-label strong {
      font-size: 14px;
    }

    #expr-count {
      font-size: 12px;
      color: var(--graphite);
      opacity: .8;
    }

    #expr-chips {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }

    /* Primary buttons – match Home / About */
    .btn {
      display: inline-block;
      border: none;
      padding: 10px 16px;
      border-radius: 12px;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: all .2s;
    }

    .btn:hover {
      background: #b85f22;
      transform: translateY(-1px);
    }

    .btn:active {
      transform: scale(.97);
    }

    .marquee-wrap{overflow:hidden;margin:10px 0 22px}
    .marquee{display:flex;gap:16px;padding:8px 0;will-change:transform}
    .marq-img{width:110px;height:110px;object-fit:contain;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.06);background:#fff;flex:0 0 auto}
    @keyframes scrollLeft{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
    @keyframes scrollRight{0%{transform:translateX(-50%)}100%{transform:translateX(0)}}
    .track-left{animation:scrollLeft 50s linear infinite}
    .track-right{animation:scrollRight 53s linear infinite}
    
    /* Buttons */
    .btn{display:inline-block;border:none;padding:12px 20px;border-radius:12px;background:var(--accent);color:#fff;font-weight:600;cursor:pointer;transition:all .2s}
    .btn:hover{background:#b85f22;transform:translateY(-1px)}
    .btn:active{transform:scale(.97)}
    .btn.ghost{background:var(--accent);color:#fff}

    /* Card + rows */
    .upload-wrap{
      padding:24px 0 48px;
    }
    .card{background:#fff;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .card.upload{
      margin:0 auto;
      max-width:560px;
      padding:20px;
    }

    /* Price summary pill */
    .price-summary-card{
      margin:8px 0 16px;
      padding:10px 14px;
      border-radius:18px;
      background:rgba(44,36,25,.03);
      border:1px solid rgba(44,36,25,.06);
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:13px;
    }

    .price-summary-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .price-summary-total{
      font-weight:600;
    }

    /* Success state for the whole card */
    .card.upload.success-state{
      box-shadow:
        0 0 0 2px rgba(46,204,113,.65),
        0 10px 30px rgba(46,204,113,.25);
      border:1px solid #2ecc71;
    }

    .row{display:flex;gap:12px;align-items:center;margin:8px 0}
    label.small{font-size:12px;color:var(--graphite)}

    /* Inputs */
    input[type="email"],input[type="tel"]{width:100%;padding:10px;border:1px solid #e6e0cf;border-radius:10px}
    .field-error{
      border-color:#c0392b !important;
      box-shadow:
        0 0 0 2px rgba(192,57,43,.65),
        0 0 14px rgba(192,57,43,.45);
    }

    /* Expression chips */
    .expr-chip,
    .expression-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 999px;
      font-size: 13px;
      background: #f7f3ea;
      cursor: pointer;
      transition:
        transform .12s ease,
        box-shadow .12s ease,
        background .12s ease,
        color .12s ease;
    }

    .expr-chip:hover,
    .expression-pill:hover {
      transform: translateY(-1px);
    }

    /* orange “selected” state */
    .expr-chip.selected,
    .expression-pill.selected,
    .expression-btn.selected {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
    }

    .expr-thumb {
      font-size: 11px;
      background: #fff;
      border: 1px solid #e4cd7a;
      border-radius: 14px;
      padding: 4px 8px;
      margin-left: 6px;
    }

    /* Success state */
    .success{
      display:none;
      text-align:center;
      padding:18px 12px 24px;
    }

    /* Emoji fade-in animation */
    .success-emoji{
      opacity:0;
      transform:translateY(4px);
      animation:successFade .15s ease-out forwards;
    }

    @keyframes successFade{
      to{
        opacity:1;
        transform:translateY(0);
      }
    }

    /* Footer */
    .site-footer {
      border-top: 1px solid rgba(0,0,0,.04);
      background: #fdf7ee;
      padding: 1.5rem 0 2.5rem;
      text-align: center;
    }

    .footer-inner {
      width: min(1100px, 92%);
      margin: 0 auto;
    }

    .footer-inner p {
      font-size: 0.78rem;
      color: rgba(44,36,25,.85);
      margin-bottom: 0.75rem;
    }

    .footer-links {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
    }

    .footer-links a {
      text-decoration: none;
      color: rgba(44,36,25,.85);
      font-weight: 500;
      font-size: 0.82rem;
      transition: color 0.25s ease, text-decoration-color 0.25s ease;
    }

    .footer-links a:hover {
      color: var(--espresso);
      text-decoration: underline;
      text-decoration-color: var(--espresso);
    }

    @media (max-width: 720px) {
      .footer-links {
        flex-direction: column;
        gap: 0.6rem;
      }
    }

    @media (max-width:900px){
      .hero h1{font-size:34px}
      .marq-img{width:96px;height:96px}
    }
    @media (max-width:480px){
      .hero h1{
        font-size:30px;
      }
      .hero-sub{
        font-size:14px;
      }

      .card.upload{
        padding:16px;
      }

      .expression-pill{
        font-size:12px;
        padding:6px 10px;
      }

      .nav-btn,
      .btn{
        padding:9px 14px;
        font-size:14px;
      }

      .pack-pill-large{
        padding:10px 22px;
        font-size:15px;
      }
    }
  </style>
</head>

<body>
  <!-- Top bar -->
  <header class="topbar">
    <div class="container topbar-inner">
      <button class="nav-btn" onclick="location.href='index.html'">Home</button>
      <button class="nav-btn" onclick="location.href='our-story.html'">About</button>
    </div>
  </header>

  <!-- Marquee -->
  <div class="marquee-wrap" aria-hidden="true">
    <div id="mq1" class="marquee track-left"></div>
    <div id="mq2" class="marquee track-right"></div>
  </div>

  <!-- Hero -->
  <section class="hero">
    <div class="container" style="max-width:620px;margin:0 auto;">
      <h1>Start your pack</h1>
      <p class="hero-sub">
        Upload a selfie, add your email, and we’ll get your
        <strong>hand-drawn inspired emojis</strong> started.
      </p>
      <p class="hero-pack">
        <span id="pack-note" class="pack-pill pack-pill-large">Starter</span>
      </p>
    </div>
  </section>

  <!-- Upload + Expressions card -->
  <section class="upload-wrap">
    <div class="container">
      <form id="uploadForm">
        <div class="card upload">
         
          <!-- Expressions -->
          <div class="row" id="expr-row">
            <div id="expr-label">
              <strong>Pick your expressions</strong>
              <span id="expr-count">0 / 0 selected</span>
            </div>

            <div id="expr-chips">
              <button type="button" class="expression-pill expression-btn">Happy</button>
              <button type="button" class="expression-pill expression-btn">Laughing</button>
              <button type="button" class="expression-pill expression-btn">Wink</button>
              <button type="button" class="expression-pill expression-btn">Big Grin</button>
              <button type="button" class="expression-pill expression-btn">Smirk</button>

              <button type="button" class="expression-pill expression-btn">Thumbs Up</button>
              <button type="button" class="expression-pill expression-btn">Heart Eyes</button>
              <button type="button" class="expression-pill expression-btn">Surprised</button>
              <button type="button" class="expression-pill expression-btn">Face Palm</button>
              <button type="button" class="expression-pill expression-btn">Eye Roll</button>

              <button type="button" class="expression-pill expression-btn">Tired</button>
              <button type="button" class="expression-pill expression-btn">Sad</button>
              <button type="button" class="expression-pill expression-btn">Tearful</button>
              <button type="button" class="expression-pill expression-btn">Angry</button>
              <button type="button" class="expression-pill expression-btn">Mind Blown</button>

              <button type="button" class="expression-pill expression-btn">Cool (Sunglasses)</button>
              <button type="button" class="expression-pill expression-btn">Confident</button>
              <button type="button" class="expression-pill expression-btn">Skeptical</button>
              <button type="button" class="expression-pill expression-btn">Thinking</button>

              <button type="button" class="expression-pill expression-btn">Cheeky Tongue</button>
              <button type="button" class="expression-pill expression-btn">Shy</button>
              <button type="button" class="expression-pill expression-btn">Kiss</button>
              <button type="button" class="expression-pill expression-btn">Celebrating</button>

              <button type="button" class="expression-pill expression-btn">Coffee</button>
              <button type="button" class="expression-pill expression-btn">Prayer Hands</button>
            </div>

            <!-- Hidden field we fill on submit if needed later -->
            <input type="hidden" id="expressions" name="expressions" value="">
          </div>

          <!-- Promo summary (only visible if a promo exists) -->
          <div class="row" id="promo-row" style="display:none;">
            <p
              id="promo-applied"
              style="
                font-size:12px;
                font-weight:500;
                margin:2px 0 6px;
                padding:8px 10px;
                border-radius:10px;
                border:1px solid #F1D19A;
                background:#FFF9EF;
                color:#2C2419;
              "
            >
              Promo applied:
              <strong id="promo-code-label"></strong>
              — <span id="promo-percent-label"></span> off your pack.
            </p>
          </div>

          <!-- Order summary: pack + price + promo -->
          <div class="price-summary-card">
            <div class="price-summary-row">
              <span>Pack</span>
              <span id="summary-pack-label">Starter</span>
            </div>
            <div class="price-summary-row">
              <span>Pack price</span>
              <span id="summary-base-price">$5.00</span>
            </div>
            <div class="price-summary-row" id="summary-discount-row" style="display:none;">
              <span>Discount</span>
              <span id="summary-discount">- $0.00</span>
            </div>
            <div class="price-summary-row price-summary-total">
              <span>Total today</span>
              <span id="summary-final-price">$5.00</span>
            </div>
          </div>

          <!-- Email + SMS -->
          <div class="row">
            <input id="email" type="email" placeholder="Email for delivery  •  you@example.com" />
          </div>

          <div class="row">
            <label class="small" style="display:flex;align-items:center;gap:8px;">
              <input type="checkbox" id="sms-optin" style="transform:scale(1.2);" />
              Also text my emoji pack
            </label>
          </div>
          <div class="row" id="sms-row" style="display:none;">
            <input id="phone" type="tel" placeholder="Mobile number (optional)" />
          </div>
          <div class="row">
            <label class="small" style="font-size:11px;color:#5F5B53;">
              By providing your number, you agree to receive a one-time text message from Frankiemoji to deliver your emoji pack.
              Standard message rates may apply.
            </label>
          </div>

          <!-- Uploadcare picker + preview -->
          <div class="row">
            <!-- Uploadcare widget input -->
            <input
              id="u-file"
              type="hidden"
              role="uploadcare-uploader"
              data-clearable=""
              data-tabs="file camera"
              data-images-only="true"
              data-multiple="false"
              data-preview-step="true"
            />

            <!-- Where we store the picked CDN URL from Uploadcare -->
            <input id="fileUrl" type="hidden" />
          </div>

          <div id="u-preview-wrap" style="display:none;margin:10px 0 16px;">
            <img id="u-preview" alt="preview" style="max-width:100%;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.18);" />
          </div>

          <!-- Actions -->
          <div class="row" style="justify-content:flex-end; gap:10px;">
            <a class="btn" href="index.html" id="back-btn">Back</a>
            <button type="submit" class="btn" id="send-btn">Send</button>
          </div>

          <div class="success" id="success">
            <h2
              style="
                margin:0 0 4px;
                font-family:'DM Serif Display',serif;
                font-size:24px;
                letter-spacing:0.02em;
              "
            >
              You’re all set!
            </h2>

            <p
              style="
                margin:0 0 16px;
                font-family:Inter,system-ui,-apple-system,'Segoe UI',sans-serif;
                font-size:14px;
                color:#5F5B53;
              "
            >
              You’re officially part of the Frankiemoji family.
            </p>

            <!-- Branded thank-you emoji -->
            <img
              class="success-emoji"
              src="images/success-heart-hands.webp"
              alt="Thank you from Frankiemoji"
              style="
                width:120px;
                height:auto;
                margin:4px auto 10px;
                display:block;
                border-radius:18px;
                box-shadow:0 6px 18px rgba(0,0,0,.15);
              "
            />
            <p
              style="
                opacity:.85;
                margin:0 16px 10px;
                line-height:1.45;
                font-size:13px;
              "
            >
              We saved your contact details. You’ll receive your one-of-a-kind emoji portraits soon!
            </p>

            <hr
              style="
                margin:14px auto 14px;
                border:none;
                border-top:1px solid rgba(0,0,0,.06);
                width:72%;
              "
            />

            <div style="display:flex;gap:10px;justify-content:center;">
              <a class="btn" href="index.html#pricing">Home</a>
              <a class="btn" href="our-story.html">About</a>
            </div>

          </div> <!-- /success -->
        </div> <!-- /card upload -->
      </form>
  
      <!-- Status message area -->
      <div id="statusMsg"
        style="margin-top:1.25rem;text-align:center;font-size:0.9rem;"></div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-inner">
      <p>© 2025 Frankiemoji™ Studios LLC. All Rights Reserved. Born with a Pencil. Evolved with Technology.</p>
      <div class="footer-links">
        <a href="privacy.html">Privacy</a>
        <a href="terms.html">Terms</a>
        <a href="contact.html">Contact</a>
      </div>
    </div>
  </footer>

  <!-- Marquee loader (manifest → GitHub → hard fallback) -->
  <script>
  (function () {
    const GH = { owner:"martinez-frank", repo:"Emoji1", branch:"main" };
    const EXCLUDE = ["starter","standard","premium"];
    const EXTRA = [/\.ds_store/i, /%20/];

    const q = (s)=>document.querySelector(s);
    const row1 = q("#mq1"), row2 = q("#mq2");
    if (!row1 || !row2) return;

    const isOut = (s)=>{ s=(s||"").toLowerCase(); return EXCLUDE.some(x=>s.includes(x)) || EXTRA.some(rx=>rx.test(s)); };
    const shuffle = (a)=>{ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; };
    const build = (urls)=>{
      const f=document.createDocumentFragment();
      urls.concat(urls).forEach(src=>{
        const im=new Image();
        im.className="marq-img"; im.loading="lazy"; im.decoding="async"; im.alt="Frankiemoji";
        im.src=src; im.onerror=()=>im.remove();
        f.appendChild(im);
      });
      return f;
    };

    async function fromManifest(){
      try{
        const res = await fetch("images/manifest.json?cb="+Date.now(), {cache:"no-store"});
        if(!res.ok) throw 0;
        const data = await res.json();
        const list = Array.isArray(data) ? data : (Array.isArray(data.stickers) ? data.stickers : []);
        return list.map(s => String(s).startsWith("images/") ? s : `images/${s}`)
                   .filter(s => /\.(png|jpe?g|webp|gif)$/i.test(s) && !isOut(s));
      }catch{ return []; }
    }

    async function fromGitHub(){
      try{
        const url = `https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/images?ref=${GH.branch}`;
        const r = await fetch(url,{headers:{Accept:"application/vnd.github+json"}});
        if(!r.ok) throw 0;
        const items = await r.json();
        return items.filter(it=>it.type==="file")
                    .filter(it => /\.webp$/i.test(it.name))
                    .filter(it=>!isOut(it.name)&&!isOut(it.path))
                    .map(it=>it.download_url);
      }catch{ return []; }
    }

    (async ()=>{
      let urls = await fromManifest();
      if (!urls.length) {
        const gh = await fromGitHub();
        urls = gh;
      }
      if (!urls.length) {
        urls = ["images/wink.webp","images/laugh.webp","images/smirk.webp","images/ohno.webp"];
      }

      urls = shuffle([...new Set(urls)]);
      row1.appendChild(build(urls));
      row2.appendChild(build([...urls].reverse()));
      row1.style.animationDuration = (50 + Math.random()*2).toFixed(2) + "s";
      row2.style.animationDuration = (53 + Math.random()*2).toFixed(2) + "s";

      document.querySelectorAll(".marquee").forEach(m=>{
        m.addEventListener("mouseenter", ()=> m.style.animationPlayState="paused");
        m.addEventListener("mouseleave", ()=> m.style.animationPlayState="running");
      });
    })();
  })();
  </script>

  <!-- Uploadcare -->
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
  <script>window.UPLOADCARE_PUBLIC_KEY='demopublickey';</script>
  
  <!-- Page logic: pack, expressions, email/sms, Uploadcare, send -->
  <script>
  // Small helper for querySelector
  const qs = (s) => document.querySelector(s);
  let isSubmitting = false; // prevent double submits

  const formEl = document.getElementById('uploadForm');
  const cardEl = document.querySelector('.card.upload');

  // ----- Pack mapping (labels, limits, prices) -----
  const PACK_LABEL = {
    starter: 'Starter',
    standard: 'Standard',
    premium: 'Premium',
  };

  const PACK_MAX = {
    starter: 3,
    standard: 9,
    premium: 18,
  };

  // Prices in cents
  const PACK_PRICES = {
    starter: 500,   // $5
    standard: 1500, // $15
    premium: 2500,  // $25
  };

  // Promo definitions: all percent discounts
  const PROMO_DEFINITIONS = {
    frankie10:    { type: 'percent', value: 10 },
  // Backwards-compat alias – in case anyone still uses it
  frankiemoj10: { type: 'percent', value: 10 },

  holiday15:    { type: 'percent', value: 15 },
  crew100:      { type: 'percent', value: 100 },

  aaronemoji10: { type: 'percent', value: 10 },
  donniemoji10: { type: 'percent', value: 10 },
  };

  function formatCents(cents) {
    return '$' + (cents / 100).toFixed(2);
  }

  function calculatePriceForPack(packKey, promoRaw) {
    const base = PACK_PRICES[packKey] ?? 0;
    let final = base;
    let appliedPromo = '';

    if (promoRaw && base > 0) {
      const code = promoRaw.trim().toLowerCase();
      const def = PROMO_DEFINITIONS[code];
      if (def && def.type === 'percent') {
        const discount = Math.round(base * (def.value / 100));
        final = Math.max(0, base - discount);
        appliedPromo = code;
      }
    }

    return { base, final, appliedPromo };
  }

  function showPromoBanner(promoRaw) {
  if (!promoRaw) return;

  const promoRow   = document.getElementById('promo-row');
  const promoCodeEl = document.getElementById('promo-code-label');

  if (!promoRow || !promoCodeEl) return;

  promoCodeEl.textContent = promoRaw;
  promoRow.style.display = 'block';  // or 'flex', either is fine with your .row layout
}

  // Read ?pack= from the URL (default to starter)
  const params = new URLSearchParams(window.location.search);
  const pack = (params.get('pack') || 'starter').toLowerCase();

  // How many expressions allowed for this pack
  const MAX = PACK_MAX[pack] || 3;

  // ----- Update hero + price summary -----
  function updatePriceSummaryUI() {
    const promoRaw = localStorage.getItem('frankie_promo') || '';

    const { base, final, appliedPromo } = calculatePriceForPack(pack, promoRaw);

    const heroNoteEl   = document.getElementById('pack-note');
    const packLabelEl  = document.getElementById('summary-pack-label');
    const baseEl       = document.getElementById('summary-base-price');
    const finalEl      = document.getElementById('summary-final-price');
    const discountRow  = document.getElementById('summary-discount-row');
    const discountEl   = document.getElementById('summary-discount');

    const label = PACK_LABEL[pack] || 'Starter';

    if (heroNoteEl) {
      heroNoteEl.textContent = `${label} • ${formatCents(final)}`;
    }
    if (packLabelEl) packLabelEl.textContent = label;
    if (baseEl)      baseEl.textContent      = formatCents(base);
    if (finalEl)     finalEl.textContent     = formatCents(final);

    if (discountRow && discountEl) {
      const discount = base - final;
      if (discount > 0) {
        discountRow.style.display = '';
        discountEl.textContent = '- ' + formatCents(discount);
      } else {
        discountRow.style.display = 'none';
      }
    }

    // Show banner text if promo is valid
    showPromoBanner(promoRaw);

    // Stash on form for submit
    if (formEl) {
      formEl.dataset.basePriceCents  = String(base);
      formEl.dataset.finalPriceCents = String(final);
      formEl.dataset.appliedPromo    = appliedPromo || '';
    }
  }

  // ----- Prefill email if we have it in localStorage -----
  let start = {};
  try {
    start = JSON.parse(localStorage.getItem('franki:start') || '{}');
  } catch (_) {}

  if (start.email && qs('#email')) {
    qs('#email').value = start.email;
  }

  // ----- SMS toggle -----
  const optin = qs('#sms-optin');
  const smsRow = qs('#sms-row');

  if (optin && smsRow) {
    smsRow.style.display = optin.checked ? '' : 'none';
    optin.addEventListener('change', () => {
      smsRow.style.display = optin.checked ? '' : 'none';
    });
  }

  // ----- Expression chips -----
  const EXPRESSIONS = [
    'Happy', 'Laughing', 'Wink', 'Big Grin',
    'Smirk', 'Thumbs Up', 'Heart Eyes',
    'Surprised', 'Face Palm', 'Eye Roll',
    'Tired', 'Sad', 'Tearful', 'Angry',
    'Mind Blown', 'Cool (Sunglasses)',
    'Confident', 'Skeptical', 'Thinking',
    'Cheeky Tongue', 'Shy', 'Kiss',
    'Celebrating', 'Coffee', 'Prayer Hands'
  ];

  const chipsEl   = document.getElementById('expr-chips');
  const counterEl = document.getElementById('expr-count');
  const thumbEl   = document.getElementById('expr-thumbs'); // OK if null

  const selected  = new Set();

  function renderExpressions() {
    const count = selected.size;
    if (counterEl) {
      counterEl.textContent = `${count} / ${MAX} selected`;
    }
    if (thumbEl) {
      thumbEl.innerHTML = '';
      selected.forEach((name) => {
        const span = document.createElement('span');
        span.className = 'expr-thumb';
        span.textContent = name;
        thumbEl.appendChild(span);
      });
    }
  }

  function toggleChip(name, chip) {
    if (selected.has(name)) {
      selected.delete(name);
      chip.classList.remove('selected');
    } else {
      if (selected.size >= MAX) return;
      selected.add(name);
      chip.classList.add('selected');
    }
    renderExpressions();
  }

  // Attach listeners to existing buttons
  document.querySelectorAll('.expression-btn').forEach((btn) => {
    const name = btn.textContent.trim();
    btn.addEventListener('click', () => toggleChip(name, btn));
  });

  // Initial counter
  renderExpressions();

  // Initial price + promo summary
updatePriceSummary();
  
  // Make selected accessible if needed elsewhere
  window.frankiSelectedExpressions = selected;

  // Set initial price + promo summary
  updatePriceSummaryUI();

  // ----- Uploadcare widget + preview -----
  const widget       = uploadcare.Widget('#u-file');
  const fileUrlInput = document.getElementById('fileUrl');
  const previewWrap  = document.getElementById('u-preview-wrap');
  const previewImg   = document.getElementById('u-preview');

  function showPreview(cdnUrl) {
    if (!previewWrap || !previewImg) return;

    if (!cdnUrl) {
      previewWrap.style.display = 'none';
      previewImg.removeAttribute('src');
      return;
    }

    previewImg.src = cdnUrl + '-/preview/800x800/-/quality/smart/';
    previewWrap.style.display = 'block';
  }

  widget.onChange(function (file) {
    if (fileUrlInput) fileUrlInput.value = '';

    if (!file) {
      // No file selected: hide preview, keep any existing status
      showPreview('');
      return;
    }

    file.done(function (info) {
      if (!info || !info.cdnUrl) return;

      if (fileUrlInput) fileUrlInput.value = info.cdnUrl;
      showPreview(info.cdnUrl);

      // ✔ Clear any card-level error once a valid image is chosen
      if (cardEl) cardEl.classList.remove('field-error');
      setStatus('', '#2C2419'); // wipe “Please choose an image first.”
    });
  });

  // ----- Submit to /api/upload (JSON) -----
  const successEl = document.getElementById('success');
  const statusEl  = document.getElementById('statusMsg');
  const sendBtn   = document.getElementById('send-btn');

  function setStatus(msg, color) {
    if (!statusEl) return;
    statusEl.textContent = msg;
    statusEl.style.color = color || '#2C2419';
  }

  async function handleSubmit(e) {
    e.preventDefault();

    // Prevent double-submits
    if (isSubmitting) return;

    // Grab inputs
    const emailInput = document.getElementById('email');
    const phoneInput = document.getElementById('phone');

    // Clear previous error outlines
    if (emailInput) emailInput.classList.remove('field-error');
    if (cardEl) cardEl.classList.remove('field-error', 'success-state');

    const email   = emailInput?.value.trim();
    const phone   = phoneInput?.value.trim() || null;
    const fileUrl = fileUrlInput?.value;

    // ----- Validation order -----
    // 1) Image
    if (!fileUrl) {
      setStatus('Please choose an image first.', '#c0392b');
      if (cardEl) cardEl.classList.add('field-error');
      return;
    }

    // 2) Expressions
    if (!selected.size) {
      setStatus('Please pick at least one expression.', '#c0392b');
      return;
    }

    // 3) Email
    if (!email) {
      setStatus('Please enter your email.', '#c0392b');
      if (emailInput) emailInput.classList.add('field-error');
      return;
    }

    // (optional) basic email format check
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailPattern.test(email)) {
      setStatus('Please enter a valid email address.', '#c0392b');
      if (emailInput) emailInput.classList.add('field-error');
      return;
    }

    // ---- Pricing + promo from form dataset ----
    const rawPromo = localStorage.getItem('frankie_promo') || '';

    const basePriceCents  = formEl?.dataset.basePriceCents
      ? parseInt(formEl.dataset.basePriceCents, 10)
      : null;

    const finalPriceCents = formEl?.dataset.finalPriceCents
      ? parseInt(formEl.dataset.finalPriceCents, 10)
      : null;

    const appliedPromo = (formEl?.dataset.appliedPromo || rawPromo || '').trim();

    const payload = {
      pack,
      email,
      phone,
      file_url: fileUrl,
      expressions: Array.from(selected),
      promo_code: appliedPromo || null,
      base_price_cents: basePriceCents,
      final_price_cents: finalPriceCents,
      status: 'PENDING_PAYMENT',
    };

    try {
      isSubmitting = true;

      setStatus('Sending your pack details…');
      if (sendBtn) {
        sendBtn.disabled = true;
        sendBtn.textContent = 'Sending...';
      }

      const res = await fetch('/api/upload', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok || !data.ok) {
        throw new Error(data.error || `Server returned ${res.status}`);
      }

      // Success: clear status text, turn card green, show success block
      setStatus('', '#2C2419');
      if (cardEl) {
        cardEl.classList.remove('field-error');
        cardEl.classList.add('success-state');
      }

      if (successEl) {
        successEl.style.display = 'block';
        // Smoothly scroll the success message into view (nice on mobile)
        successEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // Hide Back / Send so user doesn’t resubmit
      const backBtn = document.getElementById('back-btn');
      if (backBtn) backBtn.style.display = 'none';
      if (sendBtn) sendBtn.style.display = 'none';
    } catch (err) {
      console.error(err);
      setStatus('❌ ' + (err.message || 'Upload failed'), '#c0392b');
    } finally {
      isSubmitting = false;
      if (sendBtn) {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
      }
    }
  }

  if (formEl) {
    formEl.addEventListener('submit', handleSubmit);
  }
  </script>

</body>
</html>
